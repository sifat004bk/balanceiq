# Firebase Analytics & Crashlytics Integration Guide

**Date:** January 1, 2026
**App:** `dolfin_ai`

This guide outlines the steps to integrate Firebase Crashlytics and Analytics into the `dolfin_ai` app using a Clean Architecture approach.

---

## 1. Add Dependencies

Update `apps/dolfin_ai/pubspec.yaml` to include the required Firebase packages.

```yaml
dependencies:
  # ... existing dependencies
  firebase_core: ^3.10.1
  firebase_analytics: ^11.4.1
  firebase_crashlytics: ^4.3.1
```

> **Note:** Run `flutter pub get` after saving.

---

## 2. Define Analytics Interface (In `dolfin_core`)

To decouple the app from specific analytics providers (Firebase, Mixpanel, etc.), define an interface in the core package.

**File:** `packages/core/dolfin_core/lib/analytics/analytics_service.dart`

```dart
abstract class AnalyticsService {
  /// Log a custom event
  Future<void> logEvent({
    required String name,
    Map<String, dynamic>? parameters,
  });

  /// Set user ID for tracking
  Future<void> setUserId(String id);

  /// Set user properties (e.g., plan_type, usage_count)
  Future<void> setUserProperty({
    required String name,
    required String value,
  });

  /// Log non-fatal error to Crashlytics
  Future<void> logError(dynamic exception, StackTrace? stackTrace, {dynamic reason});
}
```

---

## 3. Implement Service (In `apps/dolfin_ai`)

Implement the interface using Firebase SDKs.

**File:** `apps/dolfin_ai/lib/core/services/firebase_analytics_service.dart`

```dart
import 'package:firebase_analytics/firebase_analytics.dart';
import 'package:firebase_crashlytics/firebase_crashlytics.dart';
import 'package:dolfin_core/analytics/analytics_service.dart';

class FirebaseAnalyticsService implements AnalyticsService {
  final FirebaseAnalytics _analytics = FirebaseAnalytics.instance;
  final FirebaseCrashlytics _crashlytics = FirebaseCrashlytics.instance;

  @override
  Future<void> logEvent({
    required String name,
    Map<String, dynamic>? parameters,
  }) async {
    await _analytics.logEvent(
      name: name,
      parameters: parameters,
    );
  }

  @override
  Future<void> setUserId(String id) async {
    await _analytics.setUserId(id: id);
    await _crashlytics.setUserIdentifier(id);
  }

  @override
  Future<void> setUserProperty({
    required String name,
    required String value,
  }) async {
    await _analytics.setUserProperty(name: name, value: value);
  }

  @override
  Future<void> logError(dynamic exception, StackTrace? stackTrace, {dynamic reason}) async {
    await _crashlytics.recordError(exception, stackTrace, reason: reason);
  }
}
```

---

## 4. Register Dependency

Register the service in your dependency injection container.

**File:** `apps/dolfin_ai/lib/core/di/modules/core_module.dart`

```dart
// ... imports
import 'package:dolfin_core/analytics/analytics_service.dart';
import '../../services/firebase_analytics_service.dart';

void registerCoreModule(GetIt sl) {
  // ... existing registrations

  //! Core - Analytics
  sl.registerLazySingleton<AnalyticsService>(() => FirebaseAnalyticsService());
}
```

---

## 5. Initialize Firebase & Crashlytics

Update `main.dart` to initialize Firebase and setup global error handling.

**File:** `apps/dolfin_ai/lib/main.dart`

```dart
import 'package:firebase_core/firebase_core.dart';
import 'package:firebase_crashlytics/firebase_crashlytics.dart';
import 'firebase_options.dart'; // Generated by FlutterFire CLI

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  
  await dotenv.load(fileName: ".env");

  // 1. Initialize Firebase
  await Firebase.initializeApp(
    options: DefaultFirebaseOptions.currentPlatform,
  );

  // 2. Setup Crashlytics for fatal errors
  FlutterError.onError = (errorDetails) {
    FirebaseCrashlytics.instance.recordFlutterFatalError(errorDetails);
    // ... existing logging calls
  };

  // 3. Setup PlatformDispatcher for async errors
  PlatformDispatcher.instance.onError = (error, stack) {
    FirebaseCrashlytics.instance.recordError(error, stack, fatal: true);
    // ... existing logging calls
    return true;
  };
  
  // ... init DI and run app
}
```

---

## 6. How to Use

Inject `AnalyticsService` and use it anywhere in your app (Cubits, Repositories, etc.).

**Example: Tracking Login**

```dart
// In LoginCubit
final AnalyticsService _analytics;

Future<void> login() async {
  try {
    // ... login logic
    await _analytics.logEvent(name: 'login_success');
    await _analytics.setUserId(user.id);
  } catch (e) {
    await _analytics.logEvent(name: 'login_failure', parameters: {'reason': e.toString()});
  }
}
```

---

## Next Steps

1.  **Run `flutterfire configure`**: If you haven't already, run this to generate `firebase_options.dart`.
2.  **Add Dependencies**: Run `flutter pub add firebase_crashlytics firebase_analytics`.
3.  **Implement Code**: Follow steps 2-5 above.
